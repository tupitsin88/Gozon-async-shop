# Gozon Async Shop

В данном репозитории представлена реализация микросервисной системы электронной коммерции. Проект демонстрирует принципы
асинхронной обработки заказов, обеспечения согласованности данных в распределенных системах и реализации уведомлений в
реальном времени.

В архитектуре проекта реализованы паттерны **Transactional Outbox** и **Inbox** для обеспечения гарантированной доставки
сообщений между сервисами с использованием Apache Kafka и PostgreSQL.

## Обзор архитектуры

Система состоит из двух изолированных микросервисов и API Gateway:

* **Orders Service:** Отвечает за создание заказов. Использует паттерн Transactional Outbox для атомарного сохранения
  заказа и публикации события в Kafka.
* **Payments Service:** Потребляет события заказов, управляет балансами пользователей и обрабатывает транзакции.
  Реализует паттерн Inbox (дедупликация) для обеспечения семантики exactly-once (обработка строго один раз).
* **API Gateway (Nginx):** Маршрутизирует HTTP-запросы и проксирует WebSocket-соединения.

### Ключевые особенности

1. **Transactional Outbox:** Гарантирует отсутствие потери событий. Обновление базы данных и отправка сообщения
   происходят в рамках одной транзакции.
2. **Идемпотентность (Inbox Pattern):** Сервис платежей отслеживает ID обработанных сообщений, предотвращая дублирование
   обработки и повторное списание средств.
3. **Атомарные обновления:** Изменение баланса пользователя производится через атомарные SQL-операции для предотвращения
   состояния гонки (race conditions) при конкурентных запросах.
4. **Real-time уведомления:** Фронтенд получает мгновенные обновления статуса заказа через WebSockets.

## Стек технологий

* **Язык:** Go (Golang)
* **Брокер сообщений:** Apache Kafka + Zookeeper
* **База данных:** PostgreSQL (Отдельные инстансы для Orders и Payments)
* **Инфраструктура:** Docker & Docker Compose
* **API Документация:** Swagger
* **Фронтенд:** Vanilla JavaScript (Native WebSocket API)

## Начало работы

### Предварительные требования

* Docker Engine
* Docker Compose

### Установка и запуск

1. Клонируйте репозиторий.
2. Запустите инфраструктуру:

```bash
docker compose up -d --build

```

3. **Инициализация:** Пожалуйста, подождите около **30 секунд** после старта контейнеров. Это время необходимо для
   инициализации схем PostgreSQL и установки соединения сервисов с Kafka и Zookeeper.

## Руководство по использованию

### 1. Настройка аккаунта

Поскольку сервисы используют изолированные базы данных, необходимо предварительно создать учетную запись в сервисе
платежей.

**Шаг 1. Получение UUID**
Пользователи macOS и Linux могут сгенерировать уникальный идентификатор, выполнив команду в терминале:

```bash
uuidgen

```

*Скопируйте полученный результат.*

**Шаг 2. Создание счета через Swagger**
Для удобства создания аккаунта используйте интерфейс Swagger:

1. Откройте документацию сервиса платежей: http://localhost:8081/swagger/index.html
2. Раскройте метод `POST /api/payments/create_account`.
3. Нажмите кнопку **Try it out**.
4. Вставьте ваш UUID в поле `user_id` и нажмите **Execute**.

### 2. Пользовательский интерфейс

Откройте файл `client.html` в браузере.

1. В поле ввода UUID вставьте идентификатор, который вы использовали на предыдущем шаге.
2. Нажмите кнопку **Подключиться**.
3. Убедитесь, что баланс отображается корректно (изначально 0).
4. Используйте интерфейс для пополнения счета и создания заказов.

### 3. API Документация

Полная документация API доступна по следующим адресам:

* **API Gateway:** http://localhost:8000/swagger/index.html
* **Orders Service:** http://localhost:8080/swagger/index.html
* **Payments Service:** http://localhost:8081/swagger/index.html

## Структура проекта

* `/orders` — Исходный код сервиса заказов (Producer).
* `/payments` — Исходный код сервиса платежей (Consumer).
* `docker-compose.yml` — Оркестрация инфраструктуры.
* `nginx.conf` — Конфигурация API Gateway.